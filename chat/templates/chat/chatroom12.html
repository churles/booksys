{% extends 'base_layout.html' %}

{% block content %}
<div class="container">
	<div class="row d-flex justify-content-center">
		<div class="col-12">
			<form>
				<div class="form-group">
					<textarea class="form-control" id="chat-text" cols="80" rows="30"></textarea><br>
				</div>
				<div class="form-group">
					<input class="form-control" id="input" type="text" size="80">
				</div>
				<input class="btn btn-secondary btn-lg btn-black" id="submit" type="button" value="Send">
			</form>	
		</div>
	</div>
</div>
{{ room_name|json_script:"room-name" }}
{{ request.user.username|json_script:"user_username" }}
{% endblock %}

{% block scripts %}
	<script src="/static/reconnecting-websocket.js"></script>
	<script type="text/javascript">

		document.querySelector('#submit').onclick = function (e) {
			const messageInputDom = document.querySelector('#input');
			const message = messageInputDom.value;
			chatSocket.send(JSON.stringify({
				'command':'new_message',
				'message':message,
				'from':user_username
			}));
			messageInputDom.value = '';
		};

		const user_username = JSON.parse(document.getElementById('user_username').textContent);
		const roomName = JSON.parse(document.getElementById('room-name').textContent);

		const chatSocket = new ReconnectingWebSocket(
			'ws://' + 
			window.location.host +
			'/ws/chat/' +
			roomName +
			'/'
		);

		chatSocket.onmessage = function (e) {
			const data = JSON.parse(e.data);
			console.log(data)
			document.querySelector('#chat-text').value += (data.username +':   ' +data.message +'\n')
		}
		
		document.querySelector('#input').onkeyup = function(e) {
			if(e.keyCode === 13){
				document.querySelector('#submit').click();
			}
		};
	</script>
{% endblock %}